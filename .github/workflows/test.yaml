name: Test
on:
  workflow_dispatch:
    inputs:
      data_urls:
        description: 'Comma-separated Wasabi file URLs'
        required: true
        type: string
      zip_url:
        description: 'URL of zip file to download'
        required: true
        type: string

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      run_url: ${{ steps.set-run-url.outputs.run_url }}
    steps:
      - name: Set workflow run URL
        id: set-run-url
        run: |
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "Workflow Run URL: $RUN_URL"
          echo "run_url=$RUN_URL" >> $GITHUB_OUTPUT
      
      - name: Calculate matrix based on input URLs
        id: set-matrix
        run: |
          # Count URLs in comma-separated input
          IFS=',' read -ra URLS <<< "${{ inputs.data_urls }}"
          COUNT=${#URLS[@]}
          # Generate array [0, 1, 2, ..., COUNT-1]
          MATRIX="["
          for ((i=0; i<COUNT; i++)); do
            if [ $i -gt 0 ]; then
              MATRIX+=","
            fi
            MATRIX+="$i"
          done
          MATRIX+="]"
          echo "Total URLs: $COUNT"
          echo "Matrix: $MATRIX"
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  test-batch:
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 60
    strategy:
      matrix:
        batch: ${{ fromJson(needs.setup.outputs.matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'
      
      - name: Download Zip File
        run: |
          wget ${{ inputs.zip_url }} -O test.zip
          unzip test.zip
          mv $(ls -d */ | head -1 | tr -d '/') test
      
      - name: Verify Chrome
        run: google-chrome --version
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade wheel
          pip install -r test/requirements.txt
          pip install --upgrade pyautogui python-xlib
      
      - name: Run Test
        env:
          WORKFLOW_RUN_URL: ${{ needs.setup.outputs.run_url }}
        run: |
          # Get the URL for this batch
          IFS=',' read -ra URLS <<< "${{ inputs.data_urls }}"
          DATA_URL="${URLS[${{ matrix.batch }}]}"
          echo "Processing batch ${{ matrix.batch }}"
          echo "Data URL: $DATA_URL"
          echo "Workflow Run URL: $WORKFLOW_RUN_URL"
          
          # Pass the run URL to your Python script
          python test/test.py --data-url "$DATA_URL"