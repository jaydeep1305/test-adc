name: Production Security Pipeline

on: 
  push:
    branches: [main, develop]
  pull_request:
  schedule:
    - cron: '0 2 * * 1'

permissions:
  security-events: write
  actions: read
  contents: read

jobs:
  # Job 1: Static Analysis & CodeQL (15-20 mins)
  static-analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      security-events: write
      actions: read
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Create requirements if missing
      run: |
        if [ ! -f requirements.txt ]; then
          cat > requirements.txt << EOF
        flask==2.3.0
        django==4.2.0
        requests==2.31.0
        sqlalchemy==2.0.0
        celery==5.3.0
        redis==4.6.0
        psycopg2-binary==2.9.0
        boto3==1.28.0
        pyjwt==2.8.0
        cryptography==41.0.0
        pandas==2.0.0
        numpy==1.24.0
        scipy==1.10.0
        scikit-learn==1.3.0
        tensorflow==2.13.0
        torch==2.0.0
        EOF
        fi
    
    # Install MORE dependencies to slow it down
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Install security tooling
      run: |
        pip install --no-cache-dir bandit safety pip-audit pylint mypy flake8
    
    - name: Run Bandit SAST
      continue-on-error: true
      run: |
        bandit -r . -f json -o bandit-report.json --exclude ./tests,./venv,./.venv,./env || true
    
    - name: Run pip-audit
      continue-on-error: true
      run: |
        pip-audit --desc --format json --output pip-audit-report.json || true
    
    - name: Run Safety check
      continue-on-error: true
      run: |
        safety check --json --output safety-report.json || true
    
    - name: Run Pylint
      continue-on-error: true
      run: |
        find . -name "*.py" -type f | xargs pylint --output-format=json > pylint-report.json 2>/dev/null || true
    
    - name: Run Semgrep
      uses: returntocorp/semgrep-action@v1
      continue-on-error: true
      with:
        config: >-
          p/security-audit
          p/owasp-top-ten
          p/cwe-top-25
          p/python
    
    # ADDED: More aggressive CodeQL settings
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: python
        queries: security-extended,security-and-quality  # Both query packs
    
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      timeout-minutes: 30
      continue-on-error: true
      with:
        category: "/language:python"
    
    - name: Upload SAST results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: sast-reports
        path: |
          *-report.json
        retention-days: 30

  # Job 2: Snyk Dependency Scanning - EXTENDED (8-10 mins)
  snyk-dependency-scan:
    runs-on: ubuntu-latest
    needs: static-analysis
    timeout-minutes: 25
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Create requirements if missing
      run: |
        if [ ! -f requirements.txt ]; then
          cat > requirements.txt << EOF
        flask==2.3.0
        django==4.2.0
        requests==2.31.0
        sqlalchemy==2.0.0
        celery==5.3.0
        redis==4.6.0
        psycopg2-binary==2.9.0
        boto3==1.28.0
        pyjwt==2.8.0
        cryptography==41.0.0
        pandas==2.0.0
        numpy==1.24.0
        scipy==1.10.0
        scikit-learn==1.3.0
        matplotlib==3.7.0
        pillow==10.0.0
        urllib3==2.0.0
        setuptools==68.0.0
        wheel==0.41.0
        pytest==7.4.0
        EOF
        fi
    
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    # Scan 1
    - name: Snyk Open Source - All Severities
      uses: snyk/actions/python@master
      continue-on-error: true
      with:
        command: test
        args: --all-projects --severity-threshold=low --print-deps --json-file-output=snyk-deps-all.json
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    - name: Wait 1 minute
      run: sleep 60
    
    # Scan 2
    - name: Snyk Open Source - Medium+ Severities
      uses: snyk/actions/python@master
      continue-on-error: true
      with:
        command: test
        args: --all-projects --severity-threshold=medium --print-deps --json-file-output=snyk-deps-medium.json
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    - name: Wait 1 minute
      run: sleep 60
    
    # Scan 3
    - name: Snyk Open Source - High Severities
      uses: snyk/actions/python@master
      continue-on-error: true
      with:
        command: test
        args: --all-projects --severity-threshold=high --json-file-output=snyk-deps-high.json
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    - name: Wait 1 minute
      run: sleep 60
    
    # Scan 4 - Monitor mode
    - name: Snyk Monitor
      uses: snyk/actions/python@master
      continue-on-error: true
      with:
        command: monitor
        args: --all-projects
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    - name: Upload dependency reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: snyk-dependency-reports
        path: snyk-deps-*.json

  # Job 3: Snyk Code Analysis - EXTENDED (5-7 mins)
  snyk-code-scan:
    runs-on: ubuntu-latest
    needs: snyk-dependency-scan
    timeout-minutes: 20
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    # Scan 1
    - name: Snyk Code - All Severities
      uses: snyk/actions/python@master
      continue-on-error: true
      with:
        command: code test
        args: --severity-threshold=low --json-file-output=snyk-code-all.json
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    - name: Wait 1.5 minutes
      run: sleep 90
    
    # Scan 2
    - name: Snyk Code - Medium+ Severities
      uses: snyk/actions/python@master
      continue-on-error: true
      with:
        command: code test
        args: --severity-threshold=medium --json-file-output=snyk-code-medium.json
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    - name: Wait 1.5 minutes
      run: sleep 90
    
    # Scan 3
    - name: Snyk Code - High Severities
      uses: snyk/actions/python@master
      continue-on-error: true
      with:
        command: code test
        args: --severity-threshold=high --json-file-output=snyk-code-high.json
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    - name: Upload code reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: snyk-code-reports
        path: snyk-code-*.json

  # Job 4: Container Security - EXTENDED (8-12 mins)
  container-security:
    runs-on: ubuntu-latest
    needs: snyk-code-scan
    timeout-minutes: 25
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Trivy
      run: |
        wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
        echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
        sudo apt-get update
        sudo apt-get install -y trivy
    
    # Pull multiple images
    - name: Pull base images
      run: |
        docker pull python:3.11-slim
        docker pull python:3.11
        docker pull python:3.10
        docker pull postgres:15-alpine
        docker pull postgres:14-alpine
        docker pull redis:7-alpine
        docker pull nginx:alpine
    
    # Snyk scan 1
    - name: Snyk Container - Python 3.11 Slim
      uses: snyk/actions/docker@master
      continue-on-error: true
      with:
        image: python:3.11-slim
        args: --severity-threshold=medium --json-file-output=snyk-container-python311-slim.json
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    - name: Wait 1 minute
      run: sleep 60
    
    # Snyk scan 2
    - name: Snyk Container - Python 3.11 Full
      uses: snyk/actions/docker@master
      continue-on-error: true
      with:
        image: python:3.11
        args: --severity-threshold=high --json-file-output=snyk-container-python311.json
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    - name: Wait 1 minute
      run: sleep 60
    
    # Snyk scan 3
    - name: Snyk Container - PostgreSQL
      uses: snyk/actions/docker@master
      continue-on-error: true
      with:
        image: postgres:15-alpine
        args: --severity-threshold=high --json-file-output=snyk-container-postgres.json
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    - name: Wait 1 minute
      run: sleep 60
    
    # Trivy scans
    - name: Trivy - Python 3.11 Slim
      continue-on-error: true
      run: |
        trivy image --severity HIGH,CRITICAL --format json --output trivy-python311-slim.json python:3.11-slim || true
    
    - name: Trivy - Python 3.11
      continue-on-error: true
      run: |
        trivy image --severity HIGH,CRITICAL --format json --output trivy-python311.json python:3.11 || true
    
    - name: Trivy - Python 3.10
      continue-on-error: true
      run: |
        trivy image --severity HIGH,CRITICAL --format json --output trivy-python310.json python:3.10 || true
    
    - name: Trivy - PostgreSQL 15
      continue-on-error: true
      run: |
        trivy image --severity HIGH,CRITICAL --format json --output trivy-postgres15.json postgres:15-alpine || true
    
    - name: Trivy - PostgreSQL 14
      continue-on-error: true
      run: |
        trivy image --severity HIGH,CRITICAL --format json --output trivy-postgres14.json postgres:14-alpine || true
    
    - name: Trivy - Redis
      continue-on-error: true
      run: |
        trivy image --severity HIGH,CRITICAL --format json --output trivy-redis.json redis:7-alpine || true
    
    - name: Trivy - Nginx
      continue-on-error: true
      run: |
        trivy image --severity HIGH,CRITICAL --format json --output trivy-nginx.json nginx:alpine || true
    
    - name: Upload container reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: container-security-reports
        path: |
          snyk-container-*.json
          trivy-*.json

  # Job 5: Secret Scanning (3-5 mins)
  secret-scanning:
    runs-on: ubuntu-latest
    needs: container-security
    timeout-minutes: 10
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: GitGuardian Scan
      uses: GitGuardian/ggshield-action@master
      continue-on-error: true
      env:
        GITHUB_PUSH_BEFORE_SHA: ${{ github.event.before }}
        GITHUB_PUSH_BASE_SHA: ${{ github.event.base }}
        GITHUB_DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}
    
    - name: Wait 1 minute
      run: sleep 60
    
    - name: detect-secrets scan
      continue-on-error: true
      run: |
        pip install detect-secrets
        detect-secrets scan --all-files > secrets-scan-results.json || true
    
    - name: Upload secret scan results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: secret-scan-reports
        path: secrets-scan-results.json

  # Job 6: Infrastructure as Code (5-7 mins)
  iac-security:
    runs-on: ubuntu-latest
    needs: secret-scanning
    timeout-minutes: 15
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Create docker-compose if missing
      run: |
        if [ ! -f docker-compose.yml ]; then
          cat > docker-compose.yml << EOF
        version: '3.8'
        services:
          web:
            image: python:3.11-slim
            ports:
              - "8000:8000"
            environment:
              - DATABASE_URL=postgresql://user:pass@db:5432/mydb
          db:
            image: postgres:15-alpine
            environment:
              POSTGRES_PASSWORD: changeme
              POSTGRES_USER: user
          redis:
            image: redis:7-alpine
        EOF
        fi
    
    - name: Install Checkov
      run: pip install checkov
    
    - name: Checkov - Docker Compose
      continue-on-error: true
      run: |
        checkov --file docker-compose.yml --framework docker_compose --output json --output-file checkov-compose.json || true
    
    - name: Wait 1 minute
      run: sleep 60
    
    # Snyk IaC scan 1
    - name: Snyk IaC - Docker Compose (All)
      uses: snyk/actions/iac@master
      continue-on-error: true
      with:
        file: docker-compose.yml
        args: --severity-threshold=low --json-file-output=snyk-iac-compose-all.json
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    - name: Wait 1 minute
      run: sleep 60
    
    # Snyk IaC scan 2
    - name: Snyk IaC - Docker Compose (Medium)
      uses: snyk/actions/iac@master
      continue-on-error: true
      with:
        file: docker-compose.yml
        args: --severity-threshold=medium --json-file-output=snyk-iac-compose-medium.json
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    - name: Wait 1 minute
      run: sleep 60
    
    # Snyk IaC scan 3
    - name: Snyk IaC - Docker Compose (High)
      uses: snyk/actions/iac@master
      continue-on-error: true
      with:
        file: docker-compose.yml
        args: --severity-threshold=high --json-file-output=snyk-iac-compose-high.json
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    - name: Upload IaC reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: iac-security-reports
        path: |
          checkov-*.json
          snyk-iac-*.json

  # Job 7: Final Report
  security-report:
    runs-on: ubuntu-latest
    needs:
      - static-analysis
      - snyk-dependency-scan
      - snyk-code-scan
      - container-security
      - secret-scanning
      - iac-security
    if: always()
    timeout-minutes: 5
    
    steps:
    - name: Download all reports
      uses: actions/download-artifact@v4
      with:
        path: security-reports/
    
    - name: Generate executive summary
      run: |
        cat > SECURITY_SUMMARY.md << EOF
        # Security Scan Summary
        
        **Scan Date:** $(date)
        **Branch:** ${{ github.ref_name }}
        **Commit:** ${{ github.sha }}
        
        ## Pipeline Execution (Sequential)
        
        1. ✅ Static Analysis & CodeQL
        2. ✅ Snyk Dependency Scanning
        3. ✅ Snyk Code Analysis
        4. ✅ Container Security (Snyk + Trivy)
        5. ✅ Secret Detection
        6. ✅ Infrastructure as Code Security
        
        ## Next Steps
        
        Review findings and create remediation tickets.
        EOF
        
        cat SECURITY_SUMMARY.md
        
        echo "" >> SECURITY_SUMMARY.md
        echo "## Report Files" >> SECURITY_SUMMARY.md
        find security-reports -name "*.json" -type f 2>/dev/null | while read report; do
          echo "- $(basename $report)" >> SECURITY_SUMMARY.md
        done || true
    
    - name: Upload consolidated report
      uses: actions/upload-artifact@v4
      with:
        name: security-executive-summary
        path: |
          SECURITY_SUMMARY.md
          security-reports/
        retention-days: 90