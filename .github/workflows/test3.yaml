name: Production Security Pipeline

on: 
  push:
    branches: [main, develop]

permissions:
  security-events: write
  actions: read
  contents: read

jobs:
  # Job 1: Static Analysis & CodeQL (15-20 mins)
  static-analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      security-events: write
      actions: read
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Create requirements if missing
      run: |
        if [ ! -f requirements.txt ]; then
          cat > requirements.txt << 'EOF'
        flask==2.3.0
        django==4.2.0
        requests==2.31.0
        sqlalchemy==2.0.0
        celery==5.3.0
        redis==4.6.0
        psycopg2-binary==2.9.0
        boto3==1.28.0
        pyjwt==2.8.0
        cryptography==41.0.0
        pandas==2.0.0
        numpy==1.24.0
        scipy==1.10.0
        scikit-learn==1.3.0
        tensorflow==2.13.0
        torch==2.0.0
        EOF
        fi
    
    # Install MORE dependencies to slow it down
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Install security tooling
      run: |
        pip install --no-cache-dir bandit safety pip-audit pylint mypy flake8
    
    - name: Run Bandit SAST
      continue-on-error: true
      run: |
        bandit -r . -f json -o bandit-report.json --exclude ./tests,./venv,./.venv,./env || true
    
    - name: Run pip-audit
      continue-on-error: true
      run: |
        pip-audit --desc --format json --output pip-audit-report.json || true
    
    - name: Run Safety check
      continue-on-error: true
      run: |
        safety check --json --output safety-report.json || true
    
    - name: Run Pylint
      continue-on-error: true
      run: |
        find . -name "*.py" -type f | xargs pylint --output-format=json > pylint-report.json 2>/dev/null || true
    
    - name: Run Semgrep
      uses: returntocorp/semgrep-action@v1
      continue-on-error: true
      with:
        config: >-
          p/security-audit
          p/owasp-top-ten
          p/cwe-top-25
          p/python
    
    # ADDED: More aggressive CodeQL settings
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: python
        queries: security-extended,security-and-quality  # Both query packs
    
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      timeout-minutes: 30
      continue-on-error: true
      with:
        category: "/language:python"

  # Job 2: Snyk Dependency Scanning - EXTENDED (8-10 mins)
  snyk-dependency-scan:
    runs-on: ubuntu-latest
    needs: static-analysis
    timeout-minutes: 25
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Create requirements if missing
      run: |
        if [ ! -f requirements.txt ]; then
          cat > requirements.txt << 'EOF'
        # Web Frameworks
        flask==3.0.0
        django==4.2.0
        fastapi==0.104.0
        uvicorn==0.24.0
        gunicorn==21.2.0
        starlette==0.27.0

        # Database & ORM
        sqlalchemy==2.0.23
        psycopg2-binary==2.9.9
        pymongo==4.6.0
        redis==5.0.1
        alembic==1.13.1
        motor==3.3.2
        asyncpg==0.29.0

        # Message Queues & Task Processing
        celery==5.3.4
        kombu==5.3.4
        amqp==5.2.0
        kafka-python==2.0.2
        pika==1.3.2
        dramatiq==1.15.0

        # AWS Services
        boto3==1.34.0
        botocore==1.34.0
        aioboto3==12.3.0

        # HTTP & API
        requests==2.31.0
        httpx==0.25.2
        aiohttp==3.9.1
        urllib3==2.1.0
        certifi==2023.11.17

        # Authentication & Security
        pyjwt==2.8.0
        cryptography==41.0.7
        bcrypt==4.1.2
        passlib==1.7.4
        python-jose==3.3.0
        argon2-cffi==23.1.0
        oauthlib==3.2.2

        # Data Processing
        pandas==2.1.4
        numpy==1.26.2
        scipy==1.11.4
        pyarrow==14.0.2
        openpyxl==3.1.2

        # Async & Concurrency
        aioredis==2.0.1
        aiofiles==23.2.1
        greenlet==3.0.3

        # API & Serialization
        marshmallow==3.20.1
        pydantic==2.5.2
        jsonschema==4.20.0
        msgpack==1.0.7
        protobuf==4.25.1

        # Monitoring & Logging
        sentry-sdk==1.39.1
        prometheus-client==0.19.0
        structlog==23.2.0
        python-json-logger==2.0.7
        loguru==0.7.2

        # Caching
        python-memcached==1.59
        pylibmc==1.6.3
        aiocache==0.12.2

        # Testing
        pytest==7.4.3
        pytest-asyncio==0.21.1
        pytest-cov==4.1.0
        pytest-mock==3.12.0
        pytest-xdist==3.5.0
        faker==21.0.0
        factory-boy==3.3.0

        # Web Scraping & Parsing
        beautifulsoup4==4.12.2
        lxml==4.9.4
        html5lib==1.1
        cssselect==1.2.0

        # Email
        sendgrid==6.11.0
        django-celery-email==3.0.0

        # Image Processing
        pillow==10.1.0
        opencv-python==4.8.1.78

        # Task Scheduling
        apscheduler==3.10.4
        schedule==1.2.0

        # GraphQL
        graphene==3.3
        strawberry-graphql==0.215.1

        # WebSockets
        websockets==12.0
        python-socketio==5.10.0

        # Configuration
        python-decouple==3.8
        pyyaml==6.0.1
        toml==0.10.2
        configparser==6.0.0

        # Date & Time
        python-dateutil==2.8.2
        pytz==2023.3.post1
        arrow==1.3.0

        # Validation & Parsing
        validators==0.22.0
        email-validator==2.1.0
        phonenumbers==8.13.27

        # Utilities
        python-dotenv==1.0.0
        click==8.1.7
        colorama==0.4.6
        tqdm==4.66.1
        tenacity==8.2.3
        retry==0.9.2

        # Debugging & Profiling
        ipython==8.18.1
        ipdb==0.13.13
        line-profiler==4.1.1

        # Documentation
        sphinx==7.2.6
        sphinx-rtd-theme==2.0.0

        # Code Quality
        black==23.12.1
        flake8==6.1.0
        pylint==3.0.3
        mypy==1.11.2
        isort==5.13.2

        # Type Hints
        types-requests==2.31.0.10
        types-redis==4.6.0.11
        types-PyYAML==6.0.12.12
        EOF
        fi
    
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt --target=jd
    
    # Scan 1
    - name: Snyk Open Source - All Severities
      uses: snyk/actions/python@master
      continue-on-error: true
      with:
        command: test
        args: --all-projects --severity-threshold=low --print-deps --json-file-output=snyk-deps-all.json
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    
    # Scan 2
    - name: Snyk Open Source - Medium+ Severities
      uses: snyk/actions/python@master
      continue-on-error: true
      with:
        command: test
        args: --all-projects --severity-threshold=medium --print-deps --json-file-output=snyk-deps-medium.json
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    # Scan 3
    - name: Snyk Open Source - High Severities
      uses: snyk/actions/python@master
      continue-on-error: true
      with:
        command: test
        args: --all-projects --severity-threshold=high --json-file-output=snyk-deps-high.json
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    
    # Scan 4 - Monitor mode
    - name: Snyk Monitor
      uses: snyk/actions/python@master
      continue-on-error: true
      with:
        command: monitor
        args: --all-projects
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    # ADDED: More aggressive CodeQL settings
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: python
        queries: security-extended,security-and-quality  # Both query packs
    
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      timeout-minutes: 30
      continue-on-error: true
      with:
        category: "/language:python"

  # Job 3: Snyk Code Analysis - EXTENDED (5-7 mins)
  snyk-code-scan:
    runs-on: ubuntu-latest
    needs: snyk-dependency-scan
    timeout-minutes: 20
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    # Scan 1
    - name: Snyk Code - All Severities
      uses: snyk/actions/python@master
      continue-on-error: true
      with:
        command: code test
        args: --severity-threshold=low --json-file-output=snyk-code-all.json
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    - name: Wait 1.5 minutes
      run: sleep 90
    
    # Scan 2
    - name: Snyk Code - Medium+ Severities
      uses: snyk/actions/python@master
      continue-on-error: true
      with:
        command: code test
        args: --severity-threshold=medium --json-file-output=snyk-code-medium.json
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    - name: Wait 1.5 minutes
      run: sleep 90
    
    # Scan 3
    - name: Snyk Code - High Severities
      uses: snyk/actions/python@master
      continue-on-error: true
      with:
        command: code test
        args: --severity-threshold=high --json-file-output=snyk-code-high.json
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
  # Job 4: Container Security - EXTENDED (8-12 mins)
  container-security:
    runs-on: ubuntu-latest
    needs: snyk-code-scan
    timeout-minutes: 25
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Trivy
      run: |
        wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
        echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
        sudo apt-get update
        sudo apt-get install -y trivy
    
    # Pull multiple images
    - name: Pull base images
      run: |
        docker pull python:3.11-slim
        docker pull python:3.11
        docker pull python:3.10
        docker pull postgres:15-alpine
        docker pull postgres:14-alpine
        docker pull redis:7-alpine
        docker pull nginx:alpine
    
    # Snyk scan 1
    - name: Snyk Container - Python 3.11 Slim
      uses: snyk/actions/docker@master
      continue-on-error: true
      with:
        image: python:3.11-slim
        args: --severity-threshold=medium --json-file-output=snyk-container-python311-slim.json
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    
    # Snyk scan 2
    - name: Snyk Container - Python 3.11 Full
      uses: snyk/actions/docker@master
      continue-on-error: true
      with:
        image: python:3.11
        args: --severity-threshold=high --json-file-output=snyk-container-python311.json
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    
    # Snyk scan 3
    - name: Snyk Container - PostgreSQL
      uses: snyk/actions/docker@master
      continue-on-error: true
      with:
        image: postgres:15-alpine
        args: --severity-threshold=high --json-file-output=snyk-container-postgres.json
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    
    # Trivy scans
    - name: Trivy - Python 3.11 Slim
      continue-on-error: true
      run: |
        trivy image --severity HIGH,CRITICAL --format json --output trivy-python311-slim.json python:3.11-slim || true
    
    - name: Trivy - Python 3.11
      continue-on-error: true
      run: |
        trivy image --severity HIGH,CRITICAL --format json --output trivy-python311.json python:3.11 || true
    
    - name: Trivy - Python 3.10
      continue-on-error: true
      run: |
        trivy image --severity HIGH,CRITICAL --format json --output trivy-python310.json python:3.10 || true
    
    - name: Trivy - PostgreSQL 15
      continue-on-error: true
      run: |
        trivy image --severity HIGH,CRITICAL --format json --output trivy-postgres15.json postgres:15-alpine || true
    
    - name: Trivy - PostgreSQL 14
      continue-on-error: true
      run: |
        trivy image --severity HIGH,CRITICAL --format json --output trivy-postgres14.json postgres:14-alpine || true
    
    - name: Trivy - Redis
      continue-on-error: true
      run: |
        trivy image --severity HIGH,CRITICAL --format json --output trivy-redis.json redis:7-alpine || true
    
    - name: Trivy - Nginx
      continue-on-error: true
      run: |
        trivy image --severity HIGH,CRITICAL --format json --output trivy-nginx.json nginx:alpine || true
    
  # Job 5: Secret Scanning (3-5 mins)
  secret-scanning:
    runs-on: ubuntu-latest
    needs: container-security
    timeout-minutes: 10
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: GitGuardian Scan
      uses: GitGuardian/ggshield-action@master
      continue-on-error: true
      env:
        GITHUB_PUSH_BEFORE_SHA: ${{ github.event.before }}
        GITHUB_PUSH_BASE_SHA: ${{ github.event.base }}
        GITHUB_DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}
    
    
    - name: detect-secrets scan
      continue-on-error: true
      run: |
        pip install detect-secrets
        detect-secrets scan --all-files > secrets-scan-results.json || true
    
  # Job 6: Infrastructure as Code (5-7 mins)
  iac-security:
    runs-on: ubuntu-latest
    needs: secret-scanning
    timeout-minutes: 15
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Create docker-compose if missing
      run: |
        if [ ! -f docker-compose.yml ]; then
          cat > docker-compose.yml << 'EOF'
        version: '3.8'
        services:
          web:
            image: python:3.11-slim
            ports:
              - "8000:8000"
            environment:
              - DATABASE_URL=postgresql://user:pass@db:5432/mydb
          db:
            image: postgres:15-alpine
            environment:
              POSTGRES_PASSWORD: changeme
              POSTGRES_USER: user
          redis:
            image: redis:7-alpine
        EOF
        fi
    
    - name: Install Checkov
      run: pip install checkov
    
    - name: Checkov - Docker Compose
      continue-on-error: true
      run: |
        checkov --file docker-compose.yml --framework docker_compose --output json --output-file checkov-compose.json || true
    
    
    # Snyk IaC scan 1
    - name: Snyk IaC - Docker Compose (All)
      uses: snyk/actions/iac@master
      continue-on-error: true
      with:
        file: docker-compose.yml
        args: --severity-threshold=low --json-file-output=snyk-iac-compose-all.json
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    
    # Snyk IaC scan 2
    - name: Snyk IaC - Docker Compose (Medium)
      uses: snyk/actions/iac@master
      continue-on-error: true
      with:
        file: docker-compose.yml
        args: --severity-threshold=medium --json-file-output=snyk-iac-compose-medium.json
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    
    # Snyk IaC scan 3
    - name: Snyk IaC - Docker Compose (High)
      uses: snyk/actions/iac@master
      continue-on-error: true
      with:
        file: docker-compose.yml
        args: --severity-threshold=high --json-file-output=snyk-iac-compose-high.json
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}