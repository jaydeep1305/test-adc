name: Production Security Pipeline

on: 
  push:
    branches: [main, develop]
  pull_request:
  schedule:
    - cron: '0 2 * * 1'

permissions:
  security-events: write
  actions: read
  contents: read

jobs:
  # Job 1: Static Analysis & CodeQL (20-25 mins)
  static-analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      security-events: write
      actions: read
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Create requirements if missing
      run: |
        if [ ! -f requirements.txt ]; then
          cat > requirements.txt << EOF
        flask==2.3.0
        django==4.2.0
        requests==2.31.0
        sqlalchemy==2.0.0
        celery==5.3.0
        redis==4.6.0
        psycopg2-binary==2.9.0
        boto3==1.28.0
        pyjwt==2.8.0
        cryptography==41.0.0
        pandas==2.0.0
        numpy==1.24.0
        EOF
        fi
    
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Install security tooling
      run: |
        pip install --no-cache-dir bandit safety pip-audit
    
    - name: Run Bandit SAST
      continue-on-error: true
      run: |
        bandit -r . -f json -o bandit-report.json --exclude ./tests,./venv,./.venv,./env || true
    
    - name: Run pip-audit
      continue-on-error: true
      run: |
        pip-audit --desc --format json --output pip-audit-report.json || true
    
    - name: Run Safety check
      continue-on-error: true
      run: |
        safety check --json --output safety-report.json || true
    
    - name: Run Semgrep
      uses: returntocorp/semgrep-action@v1
      continue-on-error: true
      with:
        config: >-
          p/security-audit
          p/owasp-top-ten
    
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: python
        queries: security-and-quality
    
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      timeout-minutes: 30
      continue-on-error: true
      with:
        category: "/language:python"
    
    - name: Upload SAST results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: sast-reports
        path: |
          *-report.json
        retention-days: 30

  # Job 2: Snyk Dependency Scanning (8-12 mins) - RUNS AFTER JOB 1
  snyk-dependency-scan:
    runs-on: ubuntu-latest
    needs: static-analysis  # Sequential execution
    timeout-minutes: 20
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Create requirements if missing
      run: |
        if [ ! -f requirements.txt ]; then
          cat > requirements.txt << EOF
        flask==2.3.0
        django==4.2.0
        requests==2.31.0
        sqlalchemy==2.0.0
        celery==5.3.0
        redis==4.6.0
        psycopg2-binary==2.9.0
        boto3==1.28.0
        pyjwt==2.8.0
        cryptography==41.0.0
        pandas==2.0.0
        numpy==1.24.0
        scipy==1.10.0
        EOF
        fi
    
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    # Scan 1: All severity levels
    - name: Snyk Open Source - All Severities
      uses: snyk/actions/python@master
      continue-on-error: true
      with:
        command: test
        args: --all-projects --severity-threshold=low --json-file-output=snyk-deps-all.json
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    - name: Rate limit wait
      run: sleep 30
    
    # Scan 2: Medium and above
    - name: Snyk Open Source - Medium+ Severities
      uses: snyk/actions/python@master
      continue-on-error: true
      with:
        command: test
        args: --all-projects --severity-threshold=medium --json-file-output=snyk-deps-medium.json
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    - name: Rate limit wait
      run: sleep 30
    
    # Scan 3: High only
    - name: Snyk Open Source - High Severities
      uses: snyk/actions/python@master
      continue-on-error: true
      with:
        command: test
        args: --all-projects --severity-threshold=high --json-file-output=snyk-deps-high.json
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    - name: Upload dependency reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: snyk-dependency-reports
        path: snyk-deps-*.json

  # Job 3: Snyk Code Analysis (5-8 mins) - RUNS AFTER JOB 2
  snyk-code-scan:
    runs-on: ubuntu-latest
    needs: snyk-dependency-scan  # Sequential execution
    timeout-minutes: 15
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    # Scan 1: All severity
    - name: Snyk Code - All Severities
      uses: snyk/actions/python@master
      continue-on-error: true
      with:
        command: code test
        args: --severity-threshold=low --json-file-output=snyk-code-all.json
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    - name: Rate limit wait
      run: sleep 30
    
    # Scan 2: Medium and above
    - name: Snyk Code - Medium+ Severities
      uses: snyk/actions/python@master
      continue-on-error: true
      with:
        command: code test
        args: --severity-threshold=medium --json-file-output=snyk-code-medium.json
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    - name: Rate limit wait
      run: sleep 30
    
    # Scan 3: High only
    - name: Snyk Code - High Severities
      uses: snyk/actions/python@master
      continue-on-error: true
      with:
        command: code test
        args: --severity-threshold=high --json-file-output=snyk-code-high.json
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    - name: Upload code reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: snyk-code-reports
        path: snyk-code-*.json

  # Job 4: Container Security (10-15 mins) - RUNS AFTER JOB 3
  container-security:
    runs-on: ubuntu-latest
    needs: snyk-code-scan  # Sequential execution
    timeout-minutes: 20
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Trivy
      run: |
        wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
        echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
        sudo apt-get update
        sudo apt-get install -y trivy
    
    # Pull images we actually use in production
    - name: Pull base images
      run: |
        docker pull python:3.11-slim
        docker pull postgres:15-alpine
        docker pull redis:7-alpine
    
    # Snyk container scan 1
    - name: Snyk Container - Python Base
      uses: snyk/actions/docker@master
      continue-on-error: true
      with:
        image: python:3.11-slim
        args: --severity-threshold=medium --json-file-output=snyk-container-python.json
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    - name: Rate limit wait
      run: sleep 45
    
    # Snyk container scan 2
    - name: Snyk Container - PostgreSQL
      uses: snyk/actions/docker@master
      continue-on-error: true
      with:
        image: postgres:15-alpine
        args: --severity-threshold=high --json-file-output=snyk-container-postgres.json
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    - name: Rate limit wait
      run: sleep 45
    
    # Trivy scans
    - name: Trivy - Python Base
      continue-on-error: true
      run: |
        trivy image --severity HIGH,CRITICAL --format json --output trivy-python.json python:3.11-slim || true
    
    - name: Trivy - PostgreSQL
      continue-on-error: true
      run: |
        trivy image --severity HIGH,CRITICAL --format json --output trivy-postgres.json postgres:15-alpine || true
    
    - name: Trivy - Redis
      continue-on-error: true
      run: |
        trivy image --severity HIGH,CRITICAL --format json --output trivy-redis.json redis:7-alpine || true
    
    - name: Upload container reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: container-security-reports
        path: |
          snyk-container-*.json
          trivy-*.json

  # Job 5: Secret Scanning (3-5 mins) - RUNS AFTER JOB 4
  secret-scanning:
    runs-on: ubuntu-latest
    needs: container-security  # Sequential execution
    timeout-minutes: 10
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: GitGuardian Scan
      uses: GitGuardian/ggshield-action@master
      continue-on-error: true
      env:
        GITHUB_PUSH_BEFORE_SHA: ${{ github.event.before }}
        GITHUB_PUSH_BASE_SHA: ${{ github.event.base }}
        GITHUB_DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}
    
    - name: detect-secrets scan
      continue-on-error: true
      run: |
        pip install detect-secrets
        detect-secrets scan --all-files > secrets-scan-results.json || true
    
    - name: Upload secret scan results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: secret-scan-reports
        path: secrets-scan-results.json

  # Job 6: Infrastructure as Code (5-7 mins) - RUNS AFTER JOB 5
  iac-security:
    runs-on: ubuntu-latest
    needs: secret-scanning  # Sequential execution
    timeout-minutes: 12
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    # Create real IaC files if missing
    - name: Create docker-compose if missing
      run: |
        if [ ! -f docker-compose.yml ]; then
          cat > docker-compose.yml << EOF
        version: '3.8'
        services:
          web:
            image: python:3.11-slim
            ports:
              - "8000:8000"
            environment:
              - DATABASE_URL=postgresql://user:pass@db:5432/mydb
          db:
            image: postgres:15-alpine
            environment:
              POSTGRES_PASSWORD: changeme
              POSTGRES_USER: user
          redis:
            image: redis:7-alpine
        EOF
        fi
    
    # Checkov IaC scanning
    - name: Install Checkov
      run: pip install checkov
    
    - name: Checkov - Docker Compose
      continue-on-error: true
      run: |
        checkov --file docker-compose.yml --framework docker_compose --output json --output-file checkov-compose.json || true
    
    # Snyk IaC scan 1
    - name: Snyk IaC - Docker Compose (All)
      uses: snyk/actions/iac@master
      continue-on-error: true
      with:
        file: docker-compose.yml
        args: --severity-threshold=low --json-file-output=snyk-iac-compose-all.json
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    - name: Rate limit wait
      run: sleep 30
    
    # Snyk IaC scan 2
    - name: Snyk IaC - Docker Compose (High)
      uses: snyk/actions/iac@master
      continue-on-error: true
      with:
        file: docker-compose.yml
        args: --severity-threshold=high --json-file-output=snyk-iac-compose-high.json
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    - name: Upload IaC reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: iac-security-reports
        path: |
          checkov-*.json
          snyk-iac-*.json

  # Job 7: Final Report (2-3 mins) - RUNS AFTER ALL
  security-report:
    runs-on: ubuntu-latest
    needs:
      - static-analysis
      - snyk-dependency-scan
      - snyk-code-scan
      - container-security
      - secret-scanning
      - iac-security
    if: always()
    timeout-minutes: 5
    
    steps:
    - name: Download all reports
      uses: actions/download-artifact@v4
      with:
        path: security-reports/
    
    - name: Generate executive summary
      run: |
        cat > SECURITY_SUMMARY.md << EOF
        # Security Scan Summary
        
        **Scan Date:** $(date)
        **Branch:** ${{ github.ref_name }}
        **Commit:** ${{ github.sha }}
        
        ## Pipeline Execution (Sequential)
        
        1. ✅ Static Application Security Testing (SAST)
        2. ✅ Snyk Dependency Vulnerability Scanning
        3. ✅ Snyk Code Analysis (SAST)
        4. ✅ Container Security Scanning
        5. ✅ Secret Detection
        6. ✅ Infrastructure as Code Security
        
        ## Results
        
        All detailed reports are available in workflow artifacts.
        
        ## Next Steps
        
        1. Review findings by severity
        2. Create remediation tickets
        3. Update vulnerable dependencies
        4. Fix IaC misconfigurations
        EOF
        
        cat SECURITY_SUMMARY.md
        
        echo "" >> SECURITY_SUMMARY.md
        echo "## Report Files" >> SECURITY_SUMMARY.md
        find security-reports -name "*.json" -type f 2>/dev/null | while read report; do
          echo "- $(basename $report)" >> SECURITY_SUMMARY.md
        done || true
    
    - name: Upload consolidated report
      uses: actions/upload-artifact@v4
      with:
        name: security-executive-summary
        path: |
          SECURITY_SUMMARY.md
          security-reports/
        retention-days: 90