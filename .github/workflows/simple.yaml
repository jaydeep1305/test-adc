name: Process Data
on:
  workflow_dispatch:
    inputs:
      data_url:
        description: 'URL to fetch data from'
        required: true
        type: string

env:
  DISPLAY: :1
  VNC_PORT: 5901
  NOVNC_PORT: 6080

jobs:
  process:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Fetch and Parse Config
        id: config
        run: |
          # Fetch config from URL
          CONFIG=$(curl -s -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" "${{ inputs.data_url }}")
          echo "$CONFIG"
          
          # Parse VNC value (lowercase keys)
          VNC_ENABLED=$(echo "$CONFIG" | jq -r '.vnc // "false"')
          echo "vnc_enabled=$VNC_ENABLED" >> $GITHUB_OUTPUT
          
          # Parse other VNC-related values if VNC is enabled
          if [ "$VNC_ENABLED" = "true" ]; then
            CLOUDFLARE_API_TOKEN=$(echo "$CONFIG" | jq -r '.cloudflare_api_token // ""')
            CLOUDFLARE_ACCOUNT_ID=$(echo "$CONFIG" | jq -r '.cloudflare_account_id // ""')
            CLOUDFLARE_ZONE_ID=$(echo "$CONFIG" | jq -r '.cloudflare_zone_id // ""')
            HOSTNAME=$(echo "$CONFIG" | jq -r '.hostname // ""')
            VNC_PASSWORD=$(echo "$CONFIG" | jq -r '.vnc_password // ""')
            
            echo "cloudflare_api_token=$CLOUDFLARE_API_TOKEN" >> $GITHUB_OUTPUT
            echo "cloudflare_account_id=$CLOUDFLARE_ACCOUNT_ID" >> $GITHUB_OUTPUT
            echo "cloudflare_zone_id=$CLOUDFLARE_ZONE_ID" >> $GITHUB_OUTPUT
            echo "hostname=$HOSTNAME" >> $GITHUB_OUTPUT
            echo "vnc_password=$VNC_PASSWORD" >> $GITHUB_OUTPUT
            
            echo "âœ… VNC Config Loaded:"
            echo "  VNC: $VNC_ENABLED"
            echo "  Hostname: $HOSTNAME"
            echo "  Account ID: ${CLOUDFLARE_ACCOUNT_ID:0:8}..."
          fi
      
      - name: Install Desktop Environment
        if: steps.config.outputs.vnc_enabled == 'true'
        run: |
          echo "Installing XFCE desktop environment..."
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xfce4 \
            xfce4-goodies \
            xfce4-terminal \
            firefox \
            dbus-x11 \
            dbus-user-session \
            x11-utils \
            x11-apps \
            x11-common \
            x11-session-utils \
            x11-xserver-utils \
            xfonts-base \
            xfonts-100dpi \
            xfonts-75dpi \
            xfonts-cyrillic \
            xubuntu-icon-theme \
            xubuntu-wallpapers \
            gnome-icon-theme

      - name: Install TurboVNC Server
        if: steps.config.outputs.vnc_enabled == 'true'
        run: |
          echo "Installing TurboVNC server..."
          wget -q https://phoenixnap.dl.sourceforge.net/project/turbovnc/2.2.5/turbovnc_2.2.5_amd64.deb
          sudo dpkg -i turbovnc_2.2.5_amd64.deb
          rm turbovnc_2.2.5_amd64.deb

      - name: Install noVNC (Web VNC)
        if: steps.config.outputs.vnc_enabled == 'true'
        run: |
          echo "Installing noVNC for web-based access..."
          cd ~
          git clone https://github.com/novnc/noVNC.git
          cd noVNC
          git clone https://github.com/novnc/websockify.git

      - name: Configure VNC Server
        if: steps.config.outputs.vnc_enabled == 'true'
        run: |
          export PATH=$PATH:/opt/TurboVNC/bin
          mkdir -p ~/.vnc
          
          # Create password file
          echo "${{ steps.config.outputs.vnc_password }}" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          
          # Create xstartup script
          cat > ~/.vnc/xstartup.turbovnc << 'EOF'
          #!/bin/bash
          # Suppress accessibility warnings
          export NO_AT_BRIDGE=1
          export SESSION_MANAGER=""
          
          # Start XFCE desktop
          dbus-launch /usr/bin/startxfce4 &
          EOF
          
          chmod +x ~/.vnc/xstartup.turbovnc

      - name: Start VNC Server
        if: steps.config.outputs.vnc_enabled == 'true'
        run: |
          export PATH=$PATH:/opt/TurboVNC/bin
          echo "Starting TurboVNC server on display :1..."
          
          vncserver :1 -geometry 1920x1080 -depth 24 -rfbport $VNC_PORT 2>&1 | tee /tmp/vnc-start.log
          sleep 8
          
          if pgrep -f "Xvnc.*:1" > /dev/null; then
            echo "âœ… TurboVNC Server started successfully on port $VNC_PORT"
            ps aux | grep Xvnc | grep -v grep
          else
            echo "âŒ Failed to start VNC server"
            cat /tmp/vnc-start.log
            exit 1
          fi

      - name: Start noVNC (Web VNC)
        if: steps.config.outputs.vnc_enabled == 'true'
        run: |
          echo "Starting noVNC web server..."
          cd ~/noVNC
          ./utils/novnc_proxy --vnc localhost:$VNC_PORT --listen $NOVNC_PORT &
          sleep 3
          
          if netstat -tuln | grep :$NOVNC_PORT > /dev/null; then
            echo "âœ… noVNC started successfully on port $NOVNC_PORT"
          else
            echo "âŒ noVNC failed to start"
            exit 1
          fi

      - name: Install cloudflared
        if: steps.config.outputs.vnc_enabled == 'true'
        run: |
          echo "Installing cloudflared..."
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb
          cloudflared --version

      - name: Create Cloudflare Tunnel
        if: steps.config.outputs.vnc_enabled == 'true'
        id: tunnel
        run: |
          echo "Creating Cloudflare Tunnel..."
          
          RESPONSE=$(curl -s -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            "https://api.cloudflare.com/client/v4/accounts/${{ steps.config.outputs.cloudflare_account_id }}/cfd_tunnel" \
            --request POST \
            --header "Authorization: Bearer ${{ steps.config.outputs.cloudflare_api_token }}" \
            --header "Content-Type: application/json" \
            --data '{
              "name": "github-vnc-'$(date +%s)'",
              "config_src": "cloudflare"
            }')
          
          # Check if tunnel creation was successful
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success // false')
          if [ "$SUCCESS" != "true" ]; then
            echo "âŒ Failed to create tunnel"
            echo "$RESPONSE" | jq '.'
            exit 1
          fi
          
          TUNNEL_ID=$(echo "$RESPONSE" | jq -r '.result.id')
          TUNNEL_TOKEN=$(echo "$RESPONSE" | jq -r '.result.token')
          
          if [ -z "$TUNNEL_ID" ] || [ "$TUNNEL_ID" = "null" ]; then
            echo "âŒ Failed to extract tunnel ID"
            exit 1
          fi
          
          echo "tunnel_id=$TUNNEL_ID" >> $GITHUB_OUTPUT
          echo "tunnel_token=$TUNNEL_TOKEN" >> $GITHUB_OUTPUT
          echo "âœ… Tunnel created: $TUNNEL_ID"

      - name: Configure Tunnel
        if: steps.config.outputs.vnc_enabled == 'true'
        run: |
          echo "Configuring tunnel for noVNC..."
          
          RESPONSE=$(curl -s -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            "https://api.cloudflare.com/client/v4/accounts/${{ steps.config.outputs.cloudflare_account_id }}/cfd_tunnel/${{ steps.tunnel.outputs.tunnel_id }}/configurations" \
            --request PUT \
            --header "Authorization: Bearer ${{ steps.config.outputs.cloudflare_api_token }}" \
            --header "Content-Type: application/json" \
            --data "{
              \"config\": {
                \"ingress\": [
                  {
                    \"hostname\": \"${{ steps.config.outputs.hostname }}\",
                    \"service\": \"http://localhost:${NOVNC_PORT}\",
                    \"originRequest\": {}
                  },
                  {
                    \"service\": \"http_status:404\"
                  }
                ]
              }
            }")
          
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" != "true" ]; then
            echo "âŒ Failed to configure tunnel"
            echo "$RESPONSE" | jq '.'
            exit 1
          fi
          
          echo "âœ… Tunnel configured"

      - name: Create DNS Record
        if: steps.config.outputs.vnc_enabled == 'true'
        run: |
          echo "Creating DNS record..."
          
          FULL_HOSTNAME="${{ steps.config.outputs.hostname }}"
          
          EXISTING=$(curl -s -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            "https://api.cloudflare.com/client/v4/zones/${{ steps.config.outputs.cloudflare_zone_id }}/dns_records?name=${FULL_HOSTNAME}" \
            --header "Authorization: Bearer ${{ steps.config.outputs.cloudflare_api_token }}" | jq -r '.result[0].id // empty')
          
          if [ -n "$EXISTING" ]; then
            echo "âš ï¸ DNS record already exists, deleting..."
            curl -s -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
              "https://api.cloudflare.com/client/v4/zones/${{ steps.config.outputs.cloudflare_zone_id }}/dns_records/${EXISTING}" \
              --request DELETE \
              --header "Authorization: Bearer ${{ steps.config.outputs.cloudflare_api_token }}" > /dev/null
          fi
          
          RESPONSE=$(curl -s -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            "https://api.cloudflare.com/client/v4/zones/${{ steps.config.outputs.cloudflare_zone_id }}/dns_records" \
            --request POST \
            --header "Authorization: Bearer ${{ steps.config.outputs.cloudflare_api_token }}" \
            --header "Content-Type: application/json" \
            --data "{
              \"type\": \"CNAME\",
              \"proxied\": true,
              \"name\": \"${FULL_HOSTNAME}\",
              \"content\": \"${{ steps.tunnel.outputs.tunnel_id }}.cfargotunnel.com\"
            }")
          
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" != "true" ]; then
            echo "âŒ Failed to create DNS record"
            echo "$RESPONSE" | jq '.'
            exit 1
          fi
          
          echo "âœ… DNS configured"

      - name: Start Cloudflare Tunnel
        if: steps.config.outputs.vnc_enabled == 'true'
        run: |
          echo "Starting Cloudflare Tunnel..."
          cloudflared tunnel run --token ${{ steps.tunnel.outputs.tunnel_token }} > /tmp/tunnel.log 2>&1 &
          sleep 10
          
          if ! pgrep -x "cloudflared" > /dev/null; then
            echo "âŒ Cloudflare tunnel failed to start"
            cat /tmp/tunnel.log
            exit 1
          fi
          
          echo "âœ… Cloudflare Tunnel started"

      - name: Display VNC Connection Info
        if: steps.config.outputs.vnc_enabled == 'true'
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘          ðŸŽ‰ UBUNTU DESKTOP VNC IS NOW RUNNING! ðŸŽ‰            â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸŒ Access URL: https://${{ steps.config.outputs.hostname }}/vnc.html"
          echo "ðŸ”‘ Password: (configured)"
          echo ""
          
      - name: Run Moti on Desktop
        if: steps.config.outputs.vnc_enabled == 'true'
        run: |
          export DISPLAY=:1
          export NO_AT_BRIDGE=1
          export SESSION_MANAGER=""
          
          # Run Moti in a visible terminal on the desktop
          xfce4-terminal --maximize --title="Moti Process" \
            --command="bash -c 'pip install moti && moti --data-url=\"${{ inputs.data_url }}\"; echo \"Moti completed. Press Enter to close...\"; read'" 2>/dev/null &
          
          sleep 5
          
          # Verify terminal launched
          if pgrep -f "xfce4-terminal" > /dev/null; then
            echo "âœ… Moti started in desktop terminal"
          else
            echo "âš ï¸ Terminal may not have started, but continuing..."
          fi

      - name: Keep VNC Session Alive
        if: steps.config.outputs.vnc_enabled == 'true'
        run: |
          export PATH=$PATH:/opt/TurboVNC/bin
          
          echo "Keeping VNC session alive..."
          
          # Monitor for 6 hours (21600 seconds)
          END_TIME=$((SECONDS + 21600))
          
          while [ $SECONDS -lt $END_TIME ]; do
            REMAINING=$((END_TIME - SECONDS))
            HOURS=$((REMAINING / 3600))
            MINUTES=$(((REMAINING % 3600) / 60))
            
            echo "â±ï¸ Remaining: ${HOURS}h ${MINUTES}m | Access: https://${{ steps.config.outputs.hostname }}/vnc.html"
            
            # Check and restart VNC if needed
            if ! pgrep -f "Xvnc.*:1" > /dev/null; then
              echo "âŒ VNC stopped! Restarting..."
              vncserver :1 -geometry 1920x1080 -depth 24 -rfbport $VNC_PORT
              sleep 3
              if ! pgrep -f "Xvnc.*:1" > /dev/null; then
                echo "âŒ Failed to restart VNC! Exiting..."
                exit 1
              fi
              echo "âœ… VNC restarted successfully"
            fi
            
            # Check and restart tunnel if needed
            if ! pgrep -x "cloudflared" > /dev/null; then
              echo "âŒ Tunnel stopped! Restarting..."
              cloudflared tunnel run --token ${{ steps.tunnel.outputs.tunnel_token }} > /tmp/tunnel.log 2>&1 &
              sleep 5
              if ! pgrep -x "cloudflared" > /dev/null; then
                echo "âŒ Failed to restart tunnel! Exiting..."
                cat /tmp/tunnel.log
                exit 1
              fi
              echo "âœ… Tunnel restarted successfully"
            fi
            
            sleep 300
          done
          
          echo "âœ… Session time expired"

      - name: Cleanup
        if: always() && steps.config.outputs.vnc_enabled == 'true'
        run: |
          export PATH=$PATH:/opt/TurboVNC/bin
          echo "Cleaning up VNC and tunnel..."
          
          vncserver -kill :1 || true
          pkill -x cloudflared || true
          
          # Delete the Cloudflare tunnel if tunnel_id exists
          if [ -n "${{ steps.tunnel.outputs.tunnel_id }}" ] && [ "${{ steps.tunnel.outputs.tunnel_id }}" != "null" ]; then
            curl -s -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
              "https://api.cloudflare.com/client/v4/accounts/${{ steps.config.outputs.cloudflare_account_id }}/cfd_tunnel/${{ steps.tunnel.outputs.tunnel_id }}" \
              --request DELETE \
              --header "Authorization: Bearer ${{ steps.config.outputs.cloudflare_api_token }}" > /dev/null || true
          fi
          
          echo "âœ… Cleanup complete"
